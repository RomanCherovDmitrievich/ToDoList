#!/bin/bash

# –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–∫—É
set -x

# –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ª–æ–≥ —Ñ–∞–π–ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
LOG_FILE="/tmp/todolist_$(date +%Y%m%d_%H%M%S).log"
echo "=== –ó–ê–ü–£–°–ö ToDo List Planner $(date) ===" > "$LOG_FILE"

# –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –ü–†–ê–í–ò–õ–¨–ù–û
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
APP_DIR="$(dirname "$SCRIPT_DIR")"  # –ù–∞ –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ, —á–µ–º MacOS

echo "SCRIPT_DIR: $SCRIPT_DIR" >> "$LOG_FILE"
echo "APP_DIR: $APP_DIR" >> "$LOG_FILE"

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º (–í–ê–ñ–ù–û: –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ Contents!)
JAR_PATH="$APP_DIR/Resources/Java/ToDoList.jar"
JAVAFX_PATH="$APP_DIR/Frameworks/javafx-sdk-25.0.1/lib"

echo "JAR_PATH: $JAR_PATH" >> "$LOG_FILE"
echo "JAVAFX_PATH: $JAVAFX_PATH" >> "$LOG_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
echo "=== –°–¢–†–£–ö–¢–£–†–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===" >> "$LOG_FILE"
find "$APP_DIR" -type f -name "*.jar" 2>/dev/null >> "$LOG_FILE"
ls -la "$APP_DIR/Resources/Java/" 2>/dev/null >> "$LOG_FILE"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
if [ ! -f "$JAR_PATH" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: JAR —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!" >> "$LOG_FILE"
    echo "–ò—Å–∫–∞–ª–∏ –ø–æ –ø—É—Ç–∏: $JAR_PATH" >> "$LOG_FILE"
    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ Resources/Java:" >> "$LOG_FILE"
    ls -la "$(dirname "$JAR_PATH")" 2>/dev/null >> "$LOG_FILE"
    echo "‚ùå JAR —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥: $LOG_FILE"
    exit 1
fi

if [ ! -d "$JAVAFX_PATH" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: JavaFX –Ω–µ –Ω–∞–π–¥–µ–Ω!" >> "$LOG_FILE"
    echo "–ò—Å–∫–∞–ª–∏ –ø–æ –ø—É—Ç–∏: $JAVAFX_PATH" >> "$LOG_FILE"
    echo "‚ùå JavaFX –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥: $LOG_FILE"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ JavaFX
echo "=== –ü–†–û–í–ï–†–ö–ê –ú–û–î–£–õ–ï–ô JAVAFX ===" >> "$LOG_FILE"
REQUIRED_MODULES=("javafx.base.jar" "javafx.controls.jar" "javafx.fxml.jar" "javafx.graphics.jar" "javafx.media.jar")

for module in "${REQUIRED_MODULES[@]}"; do
    if [ -f "$JAVAFX_PATH/$module" ]; then
        echo "‚úÖ $module –Ω–∞–π–¥–µ–Ω" >> "$LOG_FILE"
    else
        echo "‚ùå $module –ù–ï –ù–ê–ô–î–ï–ù!" >> "$LOG_FILE"
    fi
done

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ –í–°–ï–ú–ò –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –º–æ–¥—É–ª—è–º–∏
echo "=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===" >> "$LOG_FILE"
echo "–ö–æ–º–∞–Ω–¥–∞:" >> "$LOG_FILE"
echo "java --module-path \"$JAVAFX_PATH\" --add-modules javafx.controls,javafx.fxml,javafx.graphics,javafx.base,javafx.media -jar \"$JAR_PATH\"" >> "$LOG_FILE"

/usr/bin/java --module-path "$JAVAFX_PATH" \
     --add-modules javafx.controls,javafx.fxml,javafx.graphics,javafx.base,javafx.media \
     -jar "$JAR_PATH" 2>&1 | tee -a "$LOG_FILE"

EXIT_CODE=${PIPESTATUS[0]}
echo "=== –ó–ê–í–ï–†–®–ï–ù–û –° –ö–û–î–û–ú: $EXIT_CODE ===" >> "$LOG_FILE"

if [ $EXIT_CODE -eq 0 ]; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —É—Å–ø–µ—à–Ω–æ"
    echo "–õ–æ–≥–∏ –≤: $LOG_FILE"
else
    echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $EXIT_CODE)"
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
    tail -20 "$LOG_FILE"
    echo "–ü–æ–ª–Ω—ã–π –ª–æ–≥: $LOG_FILE"
fi

# –°–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å PNG)
if [ -f "src/resources/images/app_icon.png" ]; then
    echo "üñºÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ .icns..."
    mkdir -p "ToDoList.app/Contents/Resources"
    
    # –°–æ–∑–¥–∞–µ–º .iconset –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    mkdir -p "app_icon.iconset"
    
    sips -z 16 16 src/resources/images/app_icon.png --out app_icon.iconset/icon_16x16.png
    sips -z 32 32 src/resources/images/app_icon.png --out app_icon.iconset/icon_16x16@2x.png
    sips -z 32 32 src/resources/images/app_icon.png --out app_icon.iconset/icon_32x32.png
    sips -z 64 64 src/resources/images/app_icon.png --out app_icon.iconset/icon_32x32@2x.png
    sips -z 128 128 src/resources/images/app_icon.png --out app_icon.iconset/icon_128x128.png
    sips -z 256 256 src/resources/images/app_icon.png --out app_icon.iconset/icon_128x128@2x.png
    sips -z 256 256 src/resources/images/app_icon.png --out app_icon.iconset/icon_256x256.png
    sips -z 512 512 src/resources/images/app_icon.png --out app_icon.iconset/icon_256x256@2x.png
    sips -z 512 512 src/resources/images/app_icon.png --out app_icon.iconset/icon_512x512.png
    
    # –°–æ–∑–¥–∞–µ–º .icns —Ñ–∞–π–ª
    iconutil -c icns app_icon.iconset -o ToDoList.app/Contents/Resources/app_icon.icns
    
    rm -rf app_icon.iconset
fi

exit $EXIT_CODE
